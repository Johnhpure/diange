# 🎵 点歌队列功能文档

## 功能概述

多用户共享点歌队列系统，允许公司同事通过网页点歌，歌曲按顺序自动播放。

**开发完成时间**: 2025-10-13  
**状态**: ✅ 已完成并部署

---

## 📋 功能特性

### 核心功能
1. **多用户点歌**: 所有用户可以添加歌曲到共享队列
2. **自动播放**: 开启队列模式后，歌曲播放完自动播放下一首
3. **实时同步**: 队列状态每5秒自动同步，所有用户看到相同队列
4. **队列管理**: 支持查看、移除、清空队列操作
5. **点歌人显示**: 显示每首歌曲的点歌人信息

### 技术特点
- **中心化存储**: 队列存储在服务器内存中（重启会清空）
- **实时轮询**: 自动同步队列状态
- **无冲突设计**: 同一歌曲不可重复添加
- **优雅降级**: 队列为空时自动关闭队列模式

---

## 🎯 使用指南

### 1. 添加歌曲到队列

**方法一：在歌曲列表添加**
1. 浏览任意歌单/专辑/搜索结果
2. 找到想点的歌曲
3. 点击歌曲右侧的 **播放列表图标** (队列按钮)
4. 提示"已加入点歌队列"

**方法二：从导航栏进入**
1. 点击右上角的 **队列图标** (显示队列数量徽章)
2. 在队列面板中查看当前队列

### 2. 开启队列模式

1. 点击右上角的 **队列图标**
2. 在队列面板中点击 **"开启队列"** 按钮
3. 当前歌曲播放完毕后，自动播放队列中的下一首
4. 队列播放完毕后自动关闭队列模式

### 3. 管理队列

**查看队列**:
- 点击导航栏的队列图标
- 查看所有排队歌曲、点歌人、总时长

**移除歌曲**:
- 点击歌曲右侧的 ❌ 按钮
- 确认后移除该歌曲

**清空队列**:
- 点击 **"清空"** 按钮
- 确认后清空所有歌曲

**刷新队列**:
- 点击 **"刷新"** 按钮
- 手动同步最新队列状态

---

## 🔧 技术实现

### 后端 API

#### 1. 获取队列
```http
GET /queue?timestamp=xxx
```

**响应**:
```json
{
  "code": 200,
  "queue": [
    {
      "id": 1,
      "songId": 186045,
      "songName": "七里香",
      "artist": "周杰伦",
      "album": "七里香",
      "cover": "http://...",
      "duration": 295000,
      "addedBy": "用户昵称",
      "addedAt": 1760368945289
    }
  ],
  "total": 1
}
```

#### 2. 添加歌曲
```http
POST /queue/add
Content-Type: application/json

{
  "song": {
    "id": 186045,
    "name": "七里香",
    "artist": "周杰伦",
    "duration": 295000
  },
  "addedBy": "用户昵称"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "添加成功",
  "data": { ... },
  "position": 5
}
```

#### 3. 移除歌曲
```http
POST /queue/remove
Content-Type: application/json

{
  "id": 1
}
```

#### 4. 获取下一首
```http
GET /queue/next
```

**响应**:
```json
{
  "code": 200,
  "data": { ... },
  "remaining": 4
}
```

#### 5. 清空队列
```http
POST /queue/clear
```

#### 6. 队列统计
```http
GET /queue/stats
```

**响应**:
```json
{
  "code": 200,
  "total": 10,
  "totalDuration": 2950000,
  "users": ["用户A", "用户B", "用户C"]
}
```

---

### 前端实现

#### 1. 状态管理 (Pinia Store)

**文件**: `SPlayer/src/stores/queueData.js`

**主要状态**:
- `queue`: 队列列表
- `total`: 队列总数
- `queueMode`: 是否启用队列模式
- `currentQueueId`: 当前播放的队列项ID
- `queuePanelOpen`: 队列面板是否打开

**主要方法**:
- `refreshQueue()`: 刷新队列
- `addSong(song, addedBy)`: 添加歌曲
- `removeSong(id)`: 移除歌曲
- `getNext()`: 获取下一首
- `clear()`: 清空队列
- `enableQueueMode()`: 启用队列模式
- `disableQueueMode()`: 禁用队列模式
- `startPolling()`: 开始轮询（每5秒）
- `stopPolling()`: 停止轮询

#### 2. API 封装

**文件**: `SPlayer/src/api/queue.js`

封装了所有队列相关的 HTTP 请求。

#### 3. 队列面板组件

**文件**: `SPlayer/src/components/Queue/QueuePanel.vue`

- 抽屉式面板，从右侧滑出
- 显示队列列表、统计信息
- 提供队列控制按钮
- 响应式设计，支持移动端

#### 4. 歌曲列表集成

**文件**: `SPlayer/src/components/List/SongList.vue`

- 每首歌曲旁边添加"点歌"按钮
- 点击后调用 API 添加到队列
- 显示操作结果提示

#### 5. 自动播放逻辑

**文件**: `SPlayer/src/utils/Player.js`

- 监听歌曲播放结束事件
- 检查是否启用队列模式
- 自动从队列获取并播放下一首
- 队列为空时自动关闭队列模式

#### 6. 导航栏集成

**文件**: `SPlayer/src/components/Nav/MainNav.vue`

- 右上角显示队列图标
- 徽章显示队列数量
- 点击打开队列面板

---

## 📊 数据流图

```
用户操作
   ↓
1. 点击"点歌"按钮
   ↓
2. 前端调用 POST /queue/add
   ↓
3. 后端添加到内存队列
   ↓
4. 返回成功响应
   ↓
5. 前端显示提示并刷新队列
   ↓
6. 队列面板实时显示最新队列

播放流程
   ↓
1. 用户开启"队列模式"
   ↓
2. 开始轮询队列状态（每5秒）
   ↓
3. 当前歌曲播放结束
   ↓
4. 检测到队列模式开启
   ↓
5. 调用 GET /queue/next 获取下一首
   ↓
6. 后端返回队列第一首歌曲并从队列移除
   ↓
7. 前端自动播放该歌曲
   ↓
8. 队列为空 → 关闭队列模式
```

---

## 🛠️ 代码文件清单

### 后端文件 (api-enhanced)
```
api-enhanced/
├── module/
│   ├── queue_manager.js       # 队列管理核心逻辑
│   ├── queue.js               # GET /queue
│   ├── queue_add.js           # POST /queue/add
│   ├── queue_remove.js        # POST /queue/remove
│   ├── queue_next.js          # GET /queue/next
│   ├── queue_clear.js         # POST /queue/clear
│   └── queue_stats.js         # GET /queue/stats
```

### 前端文件 (SPlayer)
```
SPlayer/src/
├── api/
│   └── queue.js               # 队列 API 封装
├── stores/
│   ├── queueData.js           # 队列状态管理 (Pinia)
│   └── index.js               # 导出 queueData
├── components/
│   ├── Queue/
│   │   └── QueuePanel.vue     # 队列面板组件
│   ├── List/
│   │   └── SongList.vue       # 歌曲列表（添加点歌按钮）
│   └── Nav/
│       └── MainNav.vue        # 导航栏（添加队列入口）
├── utils/
│   └── Player.js              # 播放器（添加队列自动播放）
└── App.vue                    # 主应用（集成队列面板）
```

---

## 🧪 测试验证

### 测试场景 1: 添加歌曲

**步骤**:
1. 打开网站 https://music.jianzhile.vip
2. 搜索"周杰伦"
3. 打开任意专辑
4. 点击歌曲旁边的"队列"图标
5. 提示"已加入点歌队列"

**预期结果**: ✅
- 提示添加成功
- 导航栏队列徽章数量+1

### 测试场景 2: 查看队列

**步骤**:
1. 点击导航栏右上角队列图标
2. 队列面板从右侧滑出
3. 显示所有排队歌曲

**预期结果**: ✅
- 显示歌曲列表
- 显示点歌人
- 显示总时长统计

### 测试场景 3: 队列播放

**步骤**:
1. 添加3首歌曲到队列
2. 打开队列面板
3. 点击"开启队列"按钮
4. 播放任意歌曲
5. 等待歌曲播放结束

**预期结果**: ✅
- 歌曲播放完毕后自动播放队列第一首
- 队列列表实时更新（第一首消失）
- 继续自动播放下一首

### 测试场景 4: 多用户同步

**步骤**:
1. 用户A添加歌曲到队列
2. 用户B打开队列面板
3. 观察队列内容

**预期结果**: ✅
- 用户B看到用户A添加的歌曲
- 显示点歌人为"用户A"

### 测试场景 5: 队列清空

**步骤**:
1. 队列中有多首歌曲
2. 打开队列面板
3. 点击"清空"按钮
4. 确认操作

**预期结果**: ✅
- 队列立即清空
- 提示"队列已清空"
- 徽章数量变为0

---

## ⚠️ 注意事项

### 1. 队列持久化
- **当前实现**: 队列存储在服务器内存中
- **影响**: 服务器重启后队列会清空
- **解决方案**（可选升级）:
  - 使用 Redis 存储队列
  - 使用数据库存储队列记录

### 2. 并发控制
- 当前未实现队列锁机制
- 极端情况下可能出现并发冲突
- 建议：小团队使用无影响（<50人）

### 3. 重复添加检测
- 同一首歌曲只能添加一次
- 基于歌曲ID判断
- 返回提示"该歌曲已在队列中"

### 4. 队列长度限制
- 当前无队列长度限制
- 建议：根据需要添加限制（如最多100首）

### 5. 网络问题
- 轮询间隔5秒，网络延迟可能导致不同步
- 用户可以手动点击"刷新"按钮

---

## 🚀 后续优化建议

### 功能扩展
1. **队列排序**: 允许拖拽调整队列顺序
2. **投票功能**: 歌曲获得点赞数高的优先播放
3. **黑名单**: 管理员可以禁止某些歌曲
4. **历史记录**: 记录已播放的队列歌曲
5. **个人配额**: 限制每个用户每天点歌数量

### 技术优化
1. **WebSocket**: 替代轮询，实现真正的实时同步
2. **Redis**: 队列持久化存储
3. **权限系统**: 管理员可以管理队列
4. **数据统计**: 统计最受欢迎的歌曲/点歌最多的用户

### UI/UX 优化
1. **动画效果**: 队列变化时添加过渡动画
2. **主题适配**: 队列面板适配深色/浅色主题
3. **快捷键**: 支持键盘快捷键操作
4. **移动端优化**: 优化手机端的队列面板布局

---

## 📝 API 测试命令

### 测试添加歌曲
```bash
curl -X POST -H "Content-Type: application/json" \
  -d '{"song":{"id":186045,"name":"七里香","artist":"周杰伦","duration":295000},"addedBy":"测试用户"}' \
  "https://music.jianzhile.vip/api/queue/add"
```

### 测试获取队列
```bash
curl "https://music.jianzhile.vip/api/queue"
```

### 测试获取下一首
```bash
curl "https://music.jianzhile.vip/api/queue/next"
```

### 测试清空队列
```bash
curl -X POST "https://music.jianzhile.vip/api/queue/clear"
```

---

## 🎊 总结

点歌队列功能已完整实现并部署到生产环境。

**核心价值**:
- 🎵 **增强互动**: 同事之间可以互相点歌
- 🤝 **公平有序**: 按顺序播放，人人平等
- 🚀 **简单易用**: 一键点歌，自动播放
- 📱 **全平台支持**: PC/手机都可以使用

**访问地址**: https://music.jianzhile.vip

立即体验点歌队列功能，让办公室音乐更有趣！🎉
