# SPlayer + api-enhanced 技术架构分析

## 系统架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │ 浏览器       │  │ Electron App │  │ 移动端浏览器              │  │
│  │ (Chrome/...)  │  │ (Desktop)    │  │ (基础适配)                │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────────────────┘  │
└─────────┼──────────────────┼──────────────────┼──────────────────────┘
          │                  │                  │
          │ HTTP/HTTPS       │ IPC + HTTP       │ HTTP/HTTPS
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         SPlayer 前端层                                │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  Vue 3 单页应用 (SPA)                                         │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────┐ │   │
│  │  │ 播放器组件 │ │ 歌词显示   │ │ 搜索模块   │ │ 用户中心 │ │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └──────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────┐ │   │
│  │  │  Axios 请求层                                          │ │   │
│  │  │  - baseURL: /api (Electron) 或外部 API                │ │   │
│  │  │  - 自动附加 Cookie (MUSIC_U)                          │ │   │
│  │  │  - 请求拦截/响应处理                                   │ │   │
│  │  └────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────┬───────────────────────────────────────────────────────┘
              │ API 请求
              │ GET /api/song/url?id=xxx
              │ GET /api/lyric?id=xxx
              │ POST /api/login/cellphone
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      中间层（可选）                                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐   │
│  │ Nginx 反向代理   │  │ Vercel Rewrites  │  │ Electron IPC    │   │
│  │ /api → :3000     │  │ /api → 外部 API   │  │ /api → :11451   │   │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘   │
└─────────────┬───────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    api-enhanced 后端层                                │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  Express.js 服务器 (端口 3000/11451)                         │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  路由层 (module/*.js)                                  │  │   │
│  │  │  /song/url, /lyric, /login/*, /playlist/*, ...        │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  网易云 API 封装层                                      │  │   │
│  │  │  - 请求加密 (Crypto-JS)                                │  │   │
│  │  │  - Cookie 管理                                         │  │   │
│  │  │  - 接口调用                                            │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  UnblockNeteaseMusic 解灰引擎                          │  │   │
│  │  │  @unblockneteasemusic/server                           │  │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐         │  │   │
│  │  │  │PyncMD  │ │QQ音乐  │ │咪咕    │ │酷狗/酷我│         │  │   │
│  │  │  │音源    │ │音源    │ │音源    │ │音源    │         │  │   │
│  │  │  └────────┘ └────────┘ └────────┘ └────────┘         │  │   │
│  │  │  - 音源匹配算法                                        │  │   │
│  │  │  - 音质选择逻辑                                        │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────┬───────────────────────────────────────────────────────┘
              │ HTTP/HTTPS 请求
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      外部服务层                                       │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────────────┐  │
│  │ 网易云音乐 API │  │ QQ音乐 API     │  │ 其他音源 API         │  │
│  │ music.163.com  │  │ y.qq.com       │  │ (咪咕/酷狗/酷我)     │  │
│  └────────────────┘  └────────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 核心依赖关系

### 1. 包依赖树

```
SPlayer (前端应用)
├── @neteaseapireborn/api@4.29.8 (Electron 内嵌)
│   ├── @unblockneteasemusic/server@0.28.0 (解灰引擎)
│   ├── express@5.1.0 (HTTP 服务器)
│   ├── axios@1.12.2 (网络请求)
│   ├── crypto-js@4.2.0 (加密)
│   └── dotenv@16.6.1 (环境变量)
├── vue@3.5.22 (前端框架)
├── axios@1.12.2 (API 请求)
├── electron@35.7.5 (桌面版支持)
├── naive-ui@2.43.1 (UI 组件库)
└── howler@2.2.4 (音频播放)

api-enhanced (后端服务)
├── @unblockneteasemusic/server@0.28.0
├── express@5.1.0
├── axios@1.12.2
├── crypto-js@4.2.0
├── music-metadata@7.14.0 (音乐元数据)
└── qrcode@1.5.4 (二维码生成)
```

### 2. 运行时依赖

```
┌─────────────────────────────────────────┐
│        SPlayer 前端运行时                │
│  - Vue 3 Composition API               │
│  - Vue Router (路由管理)               │
│  - Pinia (状态管理)                    │
│  - Axios (API 调用)                    │
│  - Howler.js (音频播放)                │
└────────────┬────────────────────────────┘
             │ 依赖
             ▼
┌─────────────────────────────────────────┐
│      api-enhanced 运行时                │
│  - Node.js >= 14                       │
│  - Express.js (Web 服务器)             │
│  - UNM Server (解灰服务)               │
└─────────────────────────────────────────┘
```

---

## 三种部署架构对比

### 架构 1：Docker 单容器部署

```
┌────────────────────────────────────────────────┐
│          Docker Container: SPlayer             │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │  Nginx (端口 7899)                       │ │
│  │  - 静态文件: /usr/share/nginx/html       │ │
│  │  - 反向代理: /api → http://localhost:3000│ │
│  └──────────┬───────────────────────────────┘ │
│             │                                  │
│             │ 同容器内部通信                    │
│             ▼                                  │
│  ┌──────────────────────────────────────────┐ │
│  │  @neteaseapireborn/api (端口 3000)       │ │
│  │  - Express 服务器                        │ │
│  │  - UnblockNeteaseMusic 解灰              │ │
│  └──────────────────────────────────────────┘ │
│                                                │
└────────────────────────────────────────────────┘
         ▲
         │ 用户访问 http://localhost:7899
         │
    ┌────┴────┐
    │ 浏览器   │
    └─────────┘
```

**优点**：
- ✅ 一键部署，配置简单
- ✅ 前后端在同一容器，无需处理跨域
- ✅ 资源占用小

**缺点**：
- ❌ 扩展性差（无法独立扩容）
- ❌ 更新需要重建容器

---

### 架构 2：分离部署（生产环境）

```
┌─────────────────────────┐         ┌─────────────────────────┐
│   前端服务器 (Vercel)    │         │  后端服务器 (VPS)       │
│                         │         │                         │
│  ┌───────────────────┐  │         │  ┌───────────────────┐  │
│  │ SPlayer 静态文件  │  │         │  │ api-enhanced      │  │
│  │ (out/renderer)    │  │         │  │ (Express Server)  │  │
│  │ - Vue 3 SPA       │  │         │  │ - 端口 3000       │  │
│  └───────────────────┘  │         │  └───────────────────┘  │
│                         │         │                         │
└────────┬────────────────┘         └────────┬────────────────┘
         │                                   │
         │ Vercel Rewrites                  │
         │ /api/* → https://api.example.com │
         └─────────────────┬─────────────────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ 用户浏览器    │
                    │ player.example.com
                    └──────────────┘
```

**优点**：
- ✅ 前后端独立扩容
- ✅ CDN 加速前端
- ✅ API 服务稳定性高

**缺点**：
- ❌ 需要处理 CORS
- ❌ 配置相对复杂
- ❌ 运维成本高

---

### 架构 3：Electron 桌面版

```
┌──────────────────────────────────────────────┐
│       Electron 应用进程                       │
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │  主进程 (Main Process)                 │ │
│  │  ┌──────────────────────────────────┐  │ │
│  │  │ startNcmServer()                 │  │ │
│  │  │ - 启动内嵌 API 服务               │  │ │
│  │  │ - 端口: 11451                    │  │ │
│  │  └──────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────┐  │ │
│  │  │ IPC 通信                         │  │ │
│  │  │ - 代理前端 /api 请求              │  │ │
│  │  └──────────────────────────────────┘  │ │
│  └────────────┬───────────────────────────┘ │
│               │                              │
│               │ IPC 消息                      │
│               ▼                              │
│  ┌────────────────────────────────────────┐ │
│  │  渲染进程 (Renderer Process)           │ │
│  │  ┌──────────────────────────────────┐  │ │
│  │  │ Vue 3 应用                       │  │ │
│  │  │ - 发起 /api/* 请求                │  │ │
│  │  └──────────────────────────────────┘  │ │
│  └────────────────────────────────────────┘ │
│                                              │
└──────────────────────────────────────────────┘
         ▲
         │ 用户操作
    ┌────┴────┐
    │ 桌面用户 │
    └─────────┘
```

**优点**：
- ✅ 无需服务器
- ✅ 离线可用（除网易云 API）
- ✅ 用户体验好

**缺点**：
- ❌ 打包体积大（~200MB）
- ❌ 跨平台兼容性需测试

---

## 数据流详解

### 1. 歌曲播放流程

```
用户点击播放
    │
    ▼
前端获取歌曲 ID
    │
    ▼
axios.get('/api/song/url', { params: { id: xxx } })
    │
    ▼
api-enhanced 接收请求
    │
    ├──► 步骤 1: 查询网易云官方 API
    │             │
    │             ├──► 有版权 → 返回官方 URL
    │             │
    │             └──► 无版权/VIP
    │                      │
    │                      ▼
    └──► 步骤 2: UnblockNeteaseMusic 解灰
                 │
                 ├──► 尝试 pyncmd 音源
                 ├──► 尝试 QQ音乐音源
                 ├──► 尝试咪咕音源
                 ├──► 尝试酷我音源
                 └──► 返回匹配的 URL
                          │
                          ▼
前端接收播放 URL
    │
    ▼
Howler.js 播放音频
```

### 2. 歌词显示流程

```
歌曲开始播放
    │
    ▼
axios.get('/api/lyric', { params: { id: xxx } })
    │
    ▼
api-enhanced 查询歌词
    │
    ├──► 逐字歌词 (TTML)
    ├──► 翻译歌词 (transLyric)
    └──► 原始歌词 (lyric)
              │
              ▼
前端解析歌词格式 (parseLyric.js)
    │
    ├──► 时间轴解析 [00:12.34]
    ├──► 逐字时间解析 <00:12.34,00:12.56>
    └──► 生成歌词数据结构
              │
              ▼
Lyric.vue 组件滚动显示
```

### 3. 用户登录流程

```
用户输入手机号+密码/二维码扫描
    │
    ▼
axios.post('/api/login/cellphone', { phone, password })
axios.get('/api/login/qr/create')
    │
    ▼
api-enhanced 调用网易云登录接口
    │
    ├──► 加密密码 (crypto-js)
    ├──► 发送登录请求
    └──► 返回 Cookie (MUSIC_U)
              │
              ▼
前端存储 Cookie (js-cookie)
    │
    ▼
后续请求自动附加 Cookie
```

---

## 技术栈详解

### 前端技术栈 (SPlayer)

| 类别           | 技术                          | 用途                         |
|----------------|-------------------------------|------------------------------|
| **框架**       | Vue 3 (Composition API)       | 响应式 UI 框架               |
| **构建工具**   | Vite 5                        | 开发服务器 + 打包            |
| **状态管理**   | Pinia                         | 全局状态（播放列表、用户信息）|
| **路由**       | Vue Router 4                  | 页面路由                     |
| **UI 组件库**  | Naive UI                      | 按钮、输入框、弹窗等         |
| **HTTP 客户端**| Axios                         | API 请求                     |
| **音频播放**   | Howler.js                     | 音频播放引擎                 |
| **歌词渲染**   | @applemusic-like-lyrics       | Apple Music 风格歌词         |
| **视频播放**   | Plyr                          | MV 播放器                    |
| **颜色提取**   | ColorThief + Material Color   | 封面主题色                   |
| **桌面支持**   | Electron 35                   | 打包为桌面应用               |

### 后端技术栈 (api-enhanced)

| 类别           | 技术                          | 用途                         |
|----------------|-------------------------------|------------------------------|
| **运行时**     | Node.js >= 14                 | JavaScript 运行环境          |
| **Web 框架**   | Express.js 5                  | HTTP 服务器                  |
| **解灰引擎**   | @unblockneteasemusic/server   | 多音源解锁                   |
| **加密**       | Crypto-JS                     | 网易云 API 加密              |
| **HTTP 客户端**| Axios                         | 调用网易云 API               |
| **元数据解析** | music-metadata                | 音乐文件信息提取             |
| **二维码生成** | qrcode                        | 登录二维码                   |
| **环境变量**   | dotenv                        | .env 配置加载                |

---

## 配置文件说明

### SPlayer 配置文件

```
SPlayer/
├── .env                    # 环境变量配置
├── vite.config.js          # Vite 构建配置
├── electron.vite.config.mjs # Electron 构建配置
├── electron-builder.yml    # 桌面版打包配置
├── nginx.conf              # Docker Nginx 配置
├── vercel.json             # Vercel 部署配置
├── docker-compose.yml      # Docker Compose 配置
└── Dockerfile              # Docker 镜像构建
```

### api-enhanced 配置文件

```
api-enhanced/
├── .env                    # 环境变量（解灰配置）
├── app.js                  # 启动入口
├── server.js               # Express 服务器
├── generateConfig.js       # 配置生成器
├── vercel.json             # Vercel 部署配置
├── Dockerfile              # Docker 镜像构建
└── module/                 # API 路由模块
    ├── login.js            # 登录接口
    ├── song.js             # 歌曲接口
    ├── lyric.js            # 歌词接口
    └── ...
```

---

## 端口使用规范

| 服务                | 默认端口 | 可配置环境变量           | 说明                  |
|---------------------|---------|-------------------------|----------------------|
| api-enhanced        | 3000    | `PORT`                  | 后端 API 服务         |
| SPlayer (Electron)  | 11451   | `MAIN_VITE_SERVER_PORT` | 桌面版内嵌 API        |
| SPlayer (Docker)    | 7899    | `MAIN_VITE_MAIN_PORT`   | Docker 容器前端端口   |
| SPlayer (开发)      | 6944    | `MAIN_VITE_DEV_PORT`    | Vite 开发服务器       |

---

## 性能优化建议

### 前端优化

1. **代码分割**
   - 路由懒加载：`component: () => import('./views/Home.vue')`
   - 组件按需导入（Naive UI）

2. **资源优化**
   - 图片懒加载：`v-lazy`
   - 封面图 WebP 格式
   - 字体子集化

3. **缓存策略**
   - IndexedDB 缓存歌单/专辑数据
   - LocalStorage 缓存用户设置
   - Service Worker 离线缓存

### 后端优化

1. **请求优化**
   - API 响应缓存（Redis）
   - 歌曲 URL 缓存（有效期 5 分钟）

2. **负载均衡**
   - Nginx 反向代理
   - PM2 集群模式

3. **CDN 加速**
   - 歌曲 URL 通过 CDN 分发
   - 静态资源 CDN 加速

---

## 安全性考虑

### 前端安全

- ✅ HTTPS 强制（生产环境）
- ✅ CSP (Content Security Policy) 配置
- ✅ XSS 防护（Vue 默认转义）
- ✅ 敏感信息不存储（密码不保存）

### 后端安全

- ✅ CORS 白名单配置
- ✅ Cookie HttpOnly（网易云 API 处理）
- ✅ 密码加密传输（MD5 Hash）
- ✅ 环境变量敏感信息（不提交 .env）

---

## 监控与日志

### 推荐监控方案

1. **前端监控**
   - Sentry（错误追踪）
   - Google Analytics（用户行为）

2. **后端监控**
   - PM2 日志管理
   - Docker logs（容器日志）
   - Prometheus + Grafana（性能监控）

3. **日志格式**
```javascript
// api-enhanced 请求日志
[2024-01-01 12:00:00] GET /api/song/url?id=123456 → 200 OK (152ms)
[2024-01-01 12:00:01] Unblock: pyncmd → 成功 (音质: 320kbps)
```

---

## 总结

### 核心架构特点

1. **前后端分离**：Vue 3 (SPA) + Express (API)
2. **多部署模式**：Docker 单容器 / 分离部署 / Electron 桌面版
3. **解灰功能**：UnblockNeteaseMusic 多音源匹配
4. **现代技术栈**：Vue 3 Composition API + Vite + TypeScript

### 关键依赖链

```
SPlayer → @neteaseapireborn/api → @unblockneteasemusic/server → 多音源 API
```

### 部署难度评级

- 🟢 **简单**：Docker 单容器（推荐新手）
- 🟡 **中等**：Electron 桌面版（需懂 Node.js）
- 🔴 **复杂**：分离部署（需运维经验）

---

**文档版本**: v1.0  
**最后更新**: 2024-01-01  
**维护者**: 技术架构分析团队