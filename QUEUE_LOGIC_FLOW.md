# ç‚¹æ­Œé˜Ÿåˆ—å®Œæ•´é€»è¾‘æµç¨‹æ–‡æ¡£

## ğŸ“‹ ä¿®æ”¹æ€»ç»“

### 1. æ ¸å¿ƒä¿®æ”¹

#### âœ… é˜Ÿåˆ—æ¨¡å¼é»˜è®¤å¼€å¯
**ä½ç½®**: `SPlayer/src/stores/queueData.js`

```javascript
state: () => ({
  queueMode: true,  // é»˜è®¤å¼€å¯ï¼ˆåŸæ¥æ˜¯ falseï¼‰
})
```

#### âœ… æ’­æ”¾åˆ—è¡¨åŠŸèƒ½å·²æ³¨é‡Š
**ä½ç½®**: 
- `SPlayer/src/components/Player/MainControl.vue` - ä¸»æ§åˆ¶æ 
- `SPlayer/src/components/Player/PlayerControl.vue` - æ’­æ”¾æ§åˆ¶å™¨

å³ä¸‹è§’çš„"æ’­æ”¾åˆ—è¡¨"å›¾æ ‡å·²è¢«æ³¨é‡Šï¼Œç”¨æˆ·çœ‹ä¸åˆ°ä¹Ÿæ— æ³•ç‚¹å‡»ã€‚

#### âœ… æ’­æ”¾å®Œæˆåè‡ªåŠ¨ç§»é™¤é€»è¾‘ä¿®å¤
**ä½ç½®**: `api-enhanced/module/queue_manager.js`

**ä¿®å¤çš„é—®é¢˜**ï¼š
- åŸé€»è¾‘ï¼šç§»é™¤å½“å‰æ­Œæ›²ååˆ `shift()` ç§»é™¤äº†ä¸‹ä¸€é¦– âŒ
- æ–°é€»è¾‘ï¼šç§»é™¤å½“å‰æ­Œæ›²ååªè¯»å–ä¸‹ä¸€é¦–ï¼ˆä¸ç§»é™¤ï¼‰âœ…

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### åœºæ™¯ï¼šç”¨æˆ·åœ¨ç‚¹æ­Œé˜Ÿåˆ—æ’­æ”¾éŸ³ä¹

```
åˆå§‹çŠ¶æ€ï¼š
é˜Ÿåˆ—ä¸­æœ‰8é¦–æ­Œ: [æ­Œ1, æ­Œ2, æ­Œ3, æ­Œ4, æ­Œ5, æ­Œ6, æ­Œ7, æ­Œ8]
queueMode = trueï¼ˆé»˜è®¤å¼€å¯ï¼‰
```

#### æ­¥éª¤1ï¼šç”¨æˆ·æ‰‹åŠ¨æ’­æ”¾ç¬¬5é¦–

```javascript
1. ç”¨æˆ·åŒå‡»é˜Ÿåˆ—ä¸­çš„ç¬¬5é¦–
   â†“
2. SongList.vue playSong() è§¦å‘
   â†“
3. æ£€æµ‹ props.sourceId === 'queue'
   â†“
4. å¼ºåˆ¶ç¡®ä¿é˜Ÿåˆ—æ¨¡å¼å¼€å¯
   if (!queue.queueMode) {
     queue.enableQueueMode(); // å¦‚æœæ²¡å¼€å¯åˆ™å¼€å¯
   }
   â†“
5. å¼€å§‹æ’­æ”¾ç¬¬5é¦–
```

#### æ­¥éª¤2ï¼šç¬¬5é¦–æ’­æ”¾å®Œæˆ

```javascript
1. player.on("end") äº‹ä»¶è§¦å‘
   â†“
2. æ£€æŸ¥é˜Ÿåˆ—æ¨¡å¼
   if (queue.queueMode && queue.hasQueue) { // âœ… ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³
   â†“
3. è·å–å½“å‰æ­Œæ›²ID
   currentSongId = music.getPlaySongData?.id || music.playSongData?.id
   console.log("ğŸµ å½“å‰æ’­æ”¾æ­Œæ›²ID:", currentSongId) // è¾“å‡ºç¬¬5é¦–çš„ID
   â†“
4. è°ƒç”¨åç«¯API
   queue.getNext(currentSongId)  // ä¼ é€’ç¬¬5é¦–çš„ID
```

#### æ­¥éª¤3ï¼šåç«¯å¤„ç†é€»è¾‘

```javascript
// api-enhanced/module/queue_manager.js getNext()

1. æ¥æ”¶åˆ° currentSongId = ç¬¬5é¦–ID
   logger.info('GET_NEXT_START', { currentSongId })
   â†“
2. åœ¨é˜Ÿåˆ—ä¸­æŸ¥æ‰¾ç¬¬5é¦–çš„ä½ç½®
   const currentIndex = songQueue.findIndex(item => 
     String(item.songId) === String(currentSongId)
   )
   // currentIndex = 4 (æ•°ç»„ç´¢å¼•ä»0å¼€å§‹)
   â†“
3. ç§»é™¤ç¬¬5é¦–
   const removedSong = songQueue.splice(currentIndex, 1)[0]
   logger.info('AUTO_REMOVE_PLAYED_SONG', {
     currentSongId,
     currentIndex: 4,
     removedSong: { songName: "ç¬¬5é¦–" },
     remainingLength: 7  // å‰©ä½™7é¦–
   })
   â†“
4. é˜Ÿåˆ—çŠ¶æ€æ›´æ–°
   é˜Ÿåˆ—å˜ä¸º: [æ­Œ1, æ­Œ2, æ­Œ3, æ­Œ4, æ­Œ6, æ­Œ7, æ­Œ8]  // ç¬¬5é¦–å·²è¢«ç§»é™¤
   â†“
5. è·å–ä¸‹ä¸€é¦–ï¼ˆä¸ç§»é™¤ï¼Œåªè¯»å–ï¼‰
   const nextIndex = currentIndex < songQueue.length ? currentIndex : 0
   // nextIndex = 4ï¼ˆç§»é™¤ç¬¬5é¦–åï¼Œç¬¬6é¦–ç°åœ¨åœ¨ä½ç½®4ï¼‰
   
   nextSong = songQueue[nextIndex]  // è¯»å–ç¬¬6é¦–ï¼ˆä¸ç§»é™¤ï¼‰
   â†“
6. è¿”å›ç¬¬6é¦–
   return {
     code: 200,
     data: nextSong,  // ç¬¬6é¦–çš„æ•°æ®
     remaining: 7     // å‰©ä½™7é¦–
   }
```

#### æ­¥éª¤4ï¼šå‰ç«¯æ’­æ”¾ä¸‹ä¸€é¦–

```javascript
1. æ”¶åˆ°åç«¯è¿”å›çš„ç¬¬6é¦–æ•°æ®
   â†“
2. æ„é€ æ­Œæ›²å¯¹è±¡
   const songData = {
     id: nextSong.songId,
     name: nextSong.songName,
     artist: nextSong.artist,
     // ...
   }
   â†“
3. æ›´æ–°å½“å‰æ’­æ”¾æ•°æ®
   music.playSongData = songData
   â†“
4. åˆå§‹åŒ–æ’­æ”¾å™¨
   await initPlayer(true)
   â†“
5. å¼€å§‹æ’­æ”¾ç¬¬6é¦–
```

#### æ­¥éª¤5ï¼šç¬¬6é¦–æ’­æ”¾å®Œæˆï¼ˆå¾ªç¯ï¼‰

```javascript
é‡å¤æ­¥éª¤2-4ï¼Œè‡ªåŠ¨æ’­æ”¾ç¬¬7é¦–
é˜Ÿåˆ—å˜ä¸º: [æ­Œ1, æ­Œ2, æ­Œ3, æ­Œ4, æ­Œ7, æ­Œ8]  // ç¬¬6é¦–ä¹Ÿè¢«ç§»é™¤
```

---

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹

### é—®é¢˜1ï¼šä¹‹å‰ä¸ºä»€ä¹ˆæ²¡ç”Ÿæ•ˆï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼šå‰ç«¯Viteè¿›ç¨‹æŒ‚æ‰äº†ï¼Œä»£ç ä¿®æ”¹æ²¡æœ‰é‡æ–°ç¼–è¯‘ï¼

```bash
# æ£€æŸ¥æ—¶å‘ç°
ps aux | grep vite
# è¾“å‡ºï¼šProcess not found

# å‰ç«¯è¿›ç¨‹å·²ç»ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¿®æ”¹çš„ä»£ç æ ¹æœ¬æ²¡åŠ è½½
```

### é—®é¢˜2ï¼šåç«¯é€»è¾‘çš„å…³é”®ä¿®å¤

**ä¹‹å‰çš„é”™è¯¯é€»è¾‘**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šç§»é™¤å½“å‰æ­Œæ›²ååˆç§»é™¤äº†ä¸‹ä¸€é¦–
const removedSong = songQueue.splice(currentIndex, 1)[0];  // ç§»é™¤ç¬¬5é¦–
const nextIndex = currentIndex < songQueue.length ? currentIndex : 0;
nextSong = songQueue.splice(nextIndex, 1)[0];  // âŒ åˆç§»é™¤äº†ç¬¬6é¦–ï¼
```

**ä¿®å¤åçš„æ­£ç¡®é€»è¾‘**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šç§»é™¤å½“å‰æ­Œæ›²ååªè¯»å–ä¸‹ä¸€é¦–
const removedSong = songQueue.splice(currentIndex, 1)[0];  // ç§»é™¤ç¬¬5é¦–
const nextIndex = currentIndex < songQueue.length ? currentIndex : 0;
nextSong = songQueue[nextIndex];  // âœ… åªè¯»å–ç¬¬6é¦–ï¼Œä¸ç§»é™¤
```

**æ ¸å¿ƒç†å¿µ**ï¼š
- æ­Œæ›²åªæœ‰åœ¨**æ’­æ”¾å®Œæˆ**æ—¶æ‰ç§»é™¤
- ç¬¬6é¦–**è¿˜æ²¡å¼€å§‹æ’­æ”¾**ï¼Œæ‰€ä»¥ä¸åº”è¯¥è¢«ç§»é™¤
- ç¬¬6é¦–å°†åœ¨**ä¸‹æ¬¡æ’­æ”¾å®Œæˆ**æ—¶è¢«ç§»é™¤

---

## ğŸ“Š é˜Ÿåˆ—çŠ¶æ€å˜åŒ–ç¤ºæ„å›¾

```
åˆå§‹é˜Ÿåˆ—: [1, 2, 3, 4, 5, 6, 7, 8]  (8é¦–æ­Œ)

ç”¨æˆ·æ’­æ”¾ç¬¬5é¦–
  â†“
æ’­æ”¾ä¸­: [1, 2, 3, 4, 5â˜…, 6, 7, 8]  (ç¬¬5é¦–æ­£åœ¨æ’­æ”¾)
  â†“
ç¬¬5é¦–æ’­æ”¾å®Œæˆ â†’ è°ƒç”¨ getNext(5)
  â†“
ç§»é™¤ç¬¬5é¦–: [1, 2, 3, 4, 6, 7, 8]  (å‰©ä½™7é¦–)
è¿”å›ç¬¬6é¦–
  â†“
æ’­æ”¾ç¬¬6é¦–: [1, 2, 3, 4, 6â˜…, 7, 8]  (ç¬¬6é¦–æ­£åœ¨æ’­æ”¾)
  â†“
ç¬¬6é¦–æ’­æ”¾å®Œæˆ â†’ è°ƒç”¨ getNext(6)
  â†“
ç§»é™¤ç¬¬6é¦–: [1, 2, 3, 4, 7, 8]  (å‰©ä½™6é¦–)
è¿”å›ç¬¬7é¦–
  â†“
æ’­æ”¾ç¬¬7é¦–: [1, 2, 3, 4, 7â˜…, 8]  (ç¬¬7é¦–æ­£åœ¨æ’­æ”¾)
  â†“
ç¬¬7é¦–æ’­æ”¾å®Œæˆ â†’ è°ƒç”¨ getNext(7)
  â†“
ç§»é™¤ç¬¬7é¦–: [1, 2, 3, 4, 8]  (å‰©ä½™5é¦–)
è¿”å›ç¬¬8é¦–
  â†“
æ’­æ”¾ç¬¬8é¦–: [1, 2, 3, 4, 8â˜…]  (ç¬¬8é¦–æ­£åœ¨æ’­æ”¾ï¼Œä¹Ÿæ˜¯æœ€åä¸€é¦–)
  â†“
ç¬¬8é¦–æ’­æ”¾å®Œæˆ â†’ è°ƒç”¨ getNext(8)
  â†“
ç§»é™¤ç¬¬8é¦–: [1, 2, 3, 4]  (å‰©ä½™4é¦–)
è¿”å›ç¬¬1é¦–ï¼ˆå¾ªç¯ï¼‰
  â†“
æ’­æ”¾ç¬¬1é¦–: [1â˜…, 2, 3, 4]  (å¾ªç¯æ’­æ”¾)
```

---

## âš™ï¸ é…ç½®çŠ¶æ€

### é˜Ÿåˆ—æ¨¡å¼å¼€å…³
- **é»˜è®¤çŠ¶æ€**: `queueMode = true` (è‡ªåŠ¨å¼€å¯)
- **å¼€å¯æ¡ä»¶**: 
  1. ç³»ç»Ÿå¯åŠ¨æ—¶é»˜è®¤å¼€å¯
  2. ä»é˜Ÿåˆ—é¡µé¢æ’­æ”¾æ­Œæ›²æ—¶å¼ºåˆ¶ç¡®ä¿å¼€å¯
- **å…³é—­æ¡ä»¶**: é˜Ÿåˆ—æ’­æ”¾å®Œæ¯•æ—¶è‡ªåŠ¨å…³é—­

### æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
- **çŠ¶æ€**: å·²æ³¨é‡Šï¼ˆUIä¸å¯è§ï¼‰
- **ä½ç½®**: å³ä¸‹è§’çš„"æ’­æ”¾åˆ—è¡¨"å›¾æ ‡
- **åŸå› **: ä¸“æ³¨äºç‚¹æ­Œé˜Ÿåˆ—åŠŸèƒ½ï¼Œé¿å…ç”¨æˆ·æ··æ·†

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ­¥éª¤

### æµ‹è¯•1ï¼šé¡ºåºæ’­æ”¾
1. æ·»åŠ 5é¦–æ­Œåˆ°é˜Ÿåˆ—
2. åŒå‡»æ’­æ”¾ç¬¬1é¦–
3. âœ… éªŒè¯ï¼šè‡ªåŠ¨æ’­æ”¾ç¬¬2é¦–ï¼Œç¬¬1é¦–å·²ä»é˜Ÿåˆ—ç§»é™¤
4. âœ… éªŒè¯ï¼šè‡ªåŠ¨æ’­æ”¾ç¬¬3é¦–ï¼Œç¬¬2é¦–å·²ä»é˜Ÿåˆ—ç§»é™¤
5. é˜Ÿåˆ—åº”è¯¥é€æ¸å‡å°‘

### æµ‹è¯•2ï¼šæ‰‹åŠ¨é€‰æ‹©æ’­æ”¾
1. æ·»åŠ 8é¦–æ­Œåˆ°é˜Ÿåˆ—
2. åŒå‡»æ’­æ”¾ç¬¬5é¦–
3. âœ… éªŒè¯ï¼šç¬¬5é¦–æ’­æ”¾å®Œåè‡ªåŠ¨æ’­æ”¾ç¬¬6é¦–
4. âœ… éªŒè¯ï¼šç¬¬5é¦–å·²ä»é˜Ÿåˆ—ç§»é™¤
5. âœ… éªŒè¯ï¼šé˜Ÿåˆ—å‰©ä½™7é¦–

### æµ‹è¯•3ï¼šæ’­æ”¾å®Œæœ€åä¸€é¦–
1. é˜Ÿåˆ—åªå‰©1é¦–æ­Œ
2. æ’­æ”¾è¿™é¦–æ­Œ
3. âœ… éªŒè¯ï¼šæ’­æ”¾å®Œåè‡ªåŠ¨æ’­æ”¾é˜Ÿåˆ—ç¬¬ä¸€é¦–ï¼ˆå¾ªç¯ï¼‰
4. âœ… éªŒè¯ï¼šè¿™é¦–æ­Œå·²è¢«ç§»é™¤

### æµ‹è¯•4ï¼šæŸ¥çœ‹æ—¥å¿—
```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤APIè¢«è°ƒç”¨
tail -f /home/chenbang/app/netease/api-enhanced/api-3001.log | grep -E "GET_NEXT|AUTO_REMOVE"

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# [INFO] GET_NEXT_START { currentSongId: 12345 }
# [INFO] AUTO_REMOVE_PLAYED_SONG { songName: "æ­Œæ›²å" }
# [INFO] GET_NEXT_SUCCESS { nextSongName: "ä¸‹ä¸€é¦–" }
```

---

## ğŸ“ å…³é”®ä»£ç ç‰‡æ®µ

### æ’­æ”¾ç»“æŸæ£€æŸ¥é€»è¾‘
```javascript
// SPlayer/src/utils/Player.js
player.on("end", async () => {
  console.info("ğŸµ æ’­æ”¾ç»“æŸ");
  
  // é˜Ÿåˆ—æ¨¡å¼æ£€æŸ¥
  if (queue.queueMode && queue.hasQueue) {
    console.log("ğŸµ é˜Ÿåˆ—æ¨¡å¼ï¼šè·å–ä¸‹ä¸€é¦–");
    const currentSongId = music.getPlaySongData?.id || music.playSongData?.id;
    console.log("ğŸµ å½“å‰æ’­æ”¾æ­Œæ›²ID:", currentSongId);
    
    const nextSong = await queue.getNext(currentSongId);
    if (nextSong) {
      // æ’­æ”¾ä¸‹ä¸€é¦–
      console.log("ğŸµ æ’­æ”¾é˜Ÿåˆ—æ­Œæ›²:", nextSong.songName);
      // ... æ’­æ”¾é€»è¾‘
    } else {
      // é˜Ÿåˆ—å·²ç©º
      console.log("â¸ï¸ é˜Ÿåˆ—å·²ç©ºï¼Œåœæ­¢æ’­æ”¾");
      queue.disableQueueMode();
    }
  }
});
```

### åç«¯ç§»é™¤é€»è¾‘
```javascript
// api-enhanced/module/queue_manager.js
function getNext(currentSongId = null) {
  if (currentSongId) {
    const currentIndex = songQueue.findIndex(item => 
      String(item.songId) === String(currentSongId)
    );
    
    if (currentIndex !== -1) {
      // ç§»é™¤æ’­æ”¾å®Œçš„æ­Œæ›²
      const removedSong = songQueue.splice(currentIndex, 1)[0];
      logger.info('AUTO_REMOVE_PLAYED_SONG', {
        songName: removedSong.songName
      });
      
      // è·å–ä¸‹ä¸€é¦–ï¼ˆåªè¯»å–ï¼Œä¸ç§»é™¤ï¼‰
      const nextIndex = currentIndex < songQueue.length ? currentIndex : 0;
      nextSong = songQueue[nextIndex];  // å…³é”®ï¼šåªè¯»å–
    }
  }
  
  return {
    code: 200,
    data: nextSong,
    remaining: songQueue.length
  };
}
```

---

## ğŸ‰ ä¿®æ”¹å®ŒæˆçŠ¶æ€

âœ… **é˜Ÿåˆ—æ¨¡å¼é»˜è®¤å¼€å¯** - æ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
âœ… **æ’­æ”¾åˆ—è¡¨åŠŸèƒ½å·²æ³¨é‡Š** - ä¸“æ³¨ç‚¹æ­Œé˜Ÿåˆ—
âœ… **è‡ªåŠ¨ç§»é™¤é€»è¾‘ä¿®å¤** - æ’­æ”¾å®Œæˆåæ­£ç¡®ç§»é™¤
âœ… **å‰åç«¯æœåŠ¡å·²é‡å¯** - æ‰€æœ‰ä¿®æ”¹å·²ç”Ÿæ•ˆ

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœè‡ªåŠ¨ç§»é™¤è¿˜æ˜¯ä¸ç”Ÿæ•ˆï¼š

1. **æ£€æŸ¥å‰ç«¯æ—¥å¿—**
```bash
# æŸ¥çœ‹å‰ç«¯æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
ğŸµ æ’­æ”¾ç»“æŸ
ğŸµ é˜Ÿåˆ—æ¨¡å¼ï¼šè·å–ä¸‹ä¸€é¦–
ğŸµ å½“å‰æ’­æ”¾æ­Œæ›²ID: 12345
ğŸµ æ’­æ”¾é˜Ÿåˆ—æ­Œæ›²: ä¸‹ä¸€é¦–æ­Œå
```

2. **æ£€æŸ¥åç«¯æ—¥å¿—**
```bash
tail -f /home/chenbang/app/netease/api-enhanced/api-3001.log | grep AUTO_REMOVE
```

3. **æ£€æŸ¥é˜Ÿåˆ—æ¨¡å¼æ˜¯å¦å¼€å¯**
```bash
# å‰ç«¯æ§åˆ¶å°è¾“å…¥ï¼š
window.$pinia.state.value.queueData.queueMode
# åº”è¯¥è¿”å› true
```

4. **æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ**
```bash
cd /home/chenbang/app/netease && bash service-guardian.sh status
```

---

ç”Ÿæˆæ—¶é—´: 2025-10-14 13:57
ä¿®æ”¹äºº: factory-droid[bot]
